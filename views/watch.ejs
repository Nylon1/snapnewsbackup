<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title><%= video.title %> | SnapShnap</title>

    <% 
      // Base URL for any relative media paths
      const MEDIA_BASE = 'https://mediacms-cw-u46015.vm.elestio.app';

      // Pick the 720p encoding (highest quality available)
      const enc720 = video.encodings_info?.["720"]?.h264?.url || "";

      // Build the full HTTPS MP4 link
      const ogVideo = enc720.startsWith('http')
        ? enc720
        : MEDIA_BASE + enc720;

      // Build the full thumbnail/ poster URL
      const ogImage = video.thumbnail_url.startsWith('http')
        ? video.thumbnail_url
        : MEDIA_BASE + video.thumbnail_url;
    %>

    <!-- Open Graph tags -->
    <meta property="og:type"        content="video.other" />
    <meta property="og:url"         content="https://snapshnap.com/watch/<%= video.friendly_token %>" />
    <meta property="og:title"       content="<%= video.title %>" />
    <meta property="og:description" content="<%= video.description || 'Watch and share news on SnapShnap.' %>" />
    <meta property="og:image"       content="<%= ogImage %>" />
    <meta property="og:video"            content="<%= ogVideo %>" />
    <meta property="og:video:secure_url" content="<%= ogVideo %>" />
    <meta property="og:video:type"       content="video/mp4" />
    <meta property="og:video:width"      content="640" />
    <meta property="og:video:height"     content="360" />

    <!-- Twitter Card tags -->
    <meta name="twitter:card"        content="player" />
    <meta name="twitter:title"       content="<%= video.title %>" />
    <meta name="twitter:description" content="<%= video.description || 'Watch and share news on SnapShsnap.' %>" />
    <meta name="twitter:image"       content="<%= ogImage %>" />
    <meta name="twitter:player"      content="<%= ogVideo %>" />
    <meta name="twitter:player:width"  content="640" />
    <meta name="twitter:player:height" content="360" />

    <style>
      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3D and Glow Keyframes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      @keyframes glow {
        0%, 100% { box-shadow: 0 0 16px 4px rgba(255,217,0,0.5); }
        50%      { box-shadow: 0 0 32px 8px rgba(255,217,0,0.85); }
      }

      /* Apply a pulsing yellow glow */
      .animate-glow-yellow {
        animation: glow 2.8s infinite alternate cubic-bezier(.4,2.2,.3,1);
      }

      /* 3D card effect on hover */
      .card-3d {
        perspective: 1000px;
        transform-style: preserve-3d;
        transition: transform 0.4s ease, box-shadow 0.4s ease;
      }
      .card-3d:hover {
        transform: perspective(1000px) rotateX(3deg) rotateY(-3deg) scale(1.02);
      }
    </style>
  </head>
  <div id="feed">
    <% if (error) { %>
      <p><%= error %></p>
    <% } else if (!videos.length) { %>
      <p>No videos from the last 24 hours.</p>
    <% } else { %>
      <% videos.forEach(function(video, idx) { %>
        <% 
          const snapshnapBase = "https://snapshnap.com";
          const videoPageUrl = snapshnapBase + "/watch/" + video.friendly_token;
        %>
        <div class="video-card" data-date="<%= video.add_date %>" id="card-<%= idx %>">
          
          <!-- Title -->
          <div class="title"><%= video.title || "Untitled" %></div>

          <!-- Upload date -->
          <div class="date">
            Uploaded: <%= new Date(video.add_date).toLocaleString() %>
          </div>

          <!-- Countdown Timer -->
          <div class="time-remaining" id="timer-<%= idx %>"></div>

          <!-- Video or Thumbnail -->
          <% if (video.file) { %>
            <video
              src="<%= video.file %>"
              controls
              poster="<%= video.thumbnail_url.startsWith('http') ? video.thumbnail_url : ('https://mediacms-cw-u46015.vm.elestio.app' + video.thumbnail_url) %>">
            </video>
          <% } else { %>
            <a href="<%= videoPageUrl %>" target="_blank">
              <img
                src="<%= video.thumbnail_url.startsWith('http') ? video.thumbnail_url : ('https://mediacms-cw-u46015.vm.elestio.app' + video.thumbnail_url) %>"
                alt="Thumbnail" />
            </a>
            <div class="fallback">
              Direct video unavailable.<br />
              <a
                href="<%= videoPageUrl %>"
                style="color:#ffd900;"
                target="_blank">Watch on SnapShnap</a>
            </div>
          <% } %>

          <!-- Share Button -->
          <div class="card-actions">
            <button
              class="share-btn"
              data-path="/watch/<%= video.friendly_token %>"
              data-idx="<%= idx %>">
              <svg fill="#191e2c" viewBox="0 0 24 24">
                <path d="M18 8a3 3 0 1 0-2.83-2H9.83A3 3 0 1 0 9 8h6zm-9 8a3 3 0 1 0 2.83 2h5.34A3 3 0 1 0 15 16H9zm1-7v2h4V9z"/>
              </svg>
              Share
            </button>
            <span class="copied-message" id="copied-<%= idx %>" style="opacity:0;">Copied!</span>
          </div>

          <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ COMMUNITY VERDICT (VOTING) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          <div class="snap-vote-card" data-videoid="<%= video.friendly_token %>">
            <h4 style="margin-top: 1rem; color: #ffd900;">Community Verdict</h4>
            <div class="vote-buttons">
              <button class="snap-vote-btn" data-vote="verified">âœ… Verified</button>
              <button class="snap-vote-btn" data-vote="fake">âš ï¸ Fake</button>
              <button class="snap-vote-btn" data-vote="satire">ğŸ­ Satire</button>
              <button class="snap-vote-btn" data-vote="context">â“ Context Needed</button>
            </div>
            <div class="vote-results">
              <div>âœ… Verified <span class="vote-label-verified">0%</span>
                <div class="bar-container"><div class="vote-bar-verified bar"></div></div>
              </div>
              <div>âš ï¸ Fake <span class="vote-label-fake">0%</span>
                <div class="bar-container"><div class="vote-bar-fake bar"></div></div>
              </div>
              <div>ğŸ­ Satire <span class="vote-label-satire">0%</span>
                <div class="bar-container"><div class="vote-bar-satire bar"></div></div>
              </div>
              <div>â“ Context <span class="vote-label-context">0%</span>
                <div class="bar-container"><div class="vote-bar-context bar"></div></div>
              </div>
            </div>
          </div>
          <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ COMMUNITY VERDICT END â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

        </div>
      <% }); %>
    <% } %>
  </div> <!-- end #feed -->

  <footer>
    &copy; <%= new Date().getFullYear() %> SnapNews &middot; All rights reserved.
  </footer>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Timer + Share Script â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script>
    // Update countdown timers every second
    function updateTimers() {
      document.querySelectorAll('.video-card').forEach(function(card, idx) {
        var dateStr = card.getAttribute('data-date');
        var created = new Date(dateStr);
        var now = new Date();
        var msElapsed = now - created;
        var msLeft = 24 * 60 * 60 * 1000 - msElapsed;
        var timer = document.getElementById('timer-' + idx);

        if (msLeft > 0) {
          var h = Math.floor(msLeft / (1000 * 60 * 60));
          var m = Math.floor((msLeft % (1000 * 60 * 60)) / (1000 * 60));
          var s = Math.floor((msLeft % (1000 * 60)) / 1000);
          timer.textContent = "Expires in: " +
            (h < 10 ? "0" : "") + h + ":" +
            (m < 10 ? "0" : "") + m + ":" +
            (s < 10 ? "0" : "") + s;
        } else {
          timer.textContent = "Expired";
        }
      });
    }
    setInterval(updateTimers, 1000);
    updateTimers();

    // Share button logic
    document.querySelectorAll('.share-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var url = window.location.origin + btn.getAttribute('data-path');
        navigator.clipboard.writeText(url).then(function() {
          var idx = btn.getAttribute('data-idx');
          var msg = document.getElementById('copied-' + idx);
          msg.style.opacity = 1;
          setTimeout(function() { msg.style.opacity = 0; }, 1800);
        });
      });
    });
  </script>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ COMMUNITYâ€VOTE HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ END COMMUNITYâ€VOTE HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script src="/js/snapVote.js"></script>
</body>
</html>


